---
applyTo: "**/*.go"
---

- **Test coverage**: This project has unit tests in `*_test.go` files alongside source files. Check for existing test files before suggesting missing tests. In particular, `internal/output/text_test.go` has comprehensive tests for all `TextFormatter.Format` paths, and `internal/client/email_test.go` tests all conversion helpers and patch structures.
- **MoveEmails replaces mailboxIds intentionally**: `MoveEmails` and `MarkAsSpam` in `internal/client/email.go` replace all `mailboxIds` with only the target mailbox. This is intentional move semantics, not a bug. Do not suggest preserving other mailbox associations.
- **Core client methods require a live JMAP server**: Functions like `ListEmails`, `ReadEmail`, `SearchEmails`, `MoveEmails` in the client package cannot be unit-tested without a real JMAP server. Their helper functions are tested instead. Do not flag missing unit tests for these methods.
- **Flag validation order**: Commands validate local flags (--limit, --before, --after) before calling `newClient()`. Do not suggest reordering validation before the client when it is already in that order.
- **Safety via structural omission**: `MoveEmails` and `MarkAsSpam` only populate the `Update` field of `Email/set`. The `Destroy` and `Create` fields are never set. This is the safety mechanism -- do not suggest adding `ValidateNoDestroy` or `ValidateNoSubmission` wrapper functions.
- **Search query is optional**: `fm search` accepts zero or one positional args. Filter-only search (no query, only flags) is a supported use case.
- **Deterministic output ordering**: `MoveEmails` and `MarkAsSpam` iterate over the input `batch` slice to build results, preserving caller-provided order. Do not suggest iterating over map keys from `r.Updated`/`r.NotUpdated`.
- **Read command error codes**: The `read` command distinguishes `not_found` (email missing) from `jmap_error` (network/JMAP failures) using `errors.Is(err, client.ErrNotFound)`. The client package defines a sentinel `ErrNotFound` error wrapped via `%w`. Do not suggest string-matching on error messages for error classification.
- **ReadEmail fetches both body value types**: `ReadEmail` always sets both `FetchHTMLBodyValues` and `FetchTextBodyValues` to true so that `extractBody` can fall back between HTML and text. Do not suggest conditional fetching based on `preferHTML`.
- **Format flag is validated early**: The `--format` flag is validated in `PersistentPreRunE` before any command runs. `output.New` intentionally falls back to JSON as a default since validation has already occurred. Do not suggest adding validation inside `output.New`.
- **Retry-After supports both formats**: `retryDelay` in `internal/client/client.go` parses `Retry-After` as both integer seconds and HTTP-date (via `http.ParseTime`). Past HTTP-dates fall through to exponential backoff. Do not suggest adding HTTP-date parsing when it is already present.
- **CLI tests use scrut**: The `tests/*.md` files are [scrut](https://github.com/facebookincubator/scrut) CLI tests. They are executed in CI via `make test-cli` (which builds the binary first, then runs `scrut test tests/`). Do not flag these as lacking a test runner.
- **JMAP response ordering guarantees**: JMAP responses are returned in invocation order (RFC 8620 section 3.3). Code that iterates `resp.Responses` in a loop and returns on `MethodError` for critical calls relies on this ordering. Do not suggest adding success-tracking flags (e.g., `gotQuery`/`gotGet`) when earlier method errors already cause early returns before optional-degradation paths execute.
- **No default case in JMAP response type switches**: All type switches on `inv.Args` intentionally omit a `default` case. The go-jmap library only deserializes into registered response types, so unexpected types do not occur in practice. Do not suggest adding `default` cases or `sawResponse` guards to these switches.
- **Scrut test patterns use `$TESTDIR`**: Tests in `tests/*.md` use the scrut variable `$TESTDIR/../fm` to reference the binary. Go drift tests in `cmd/docs_drift_test.go` match this exact pattern (e.g., `$ $TESTDIR/../fm list --help`). Do not suggest replacing `$TESTDIR/../fm` with `fm` or other binary names.
- **ValidColorNames uses intentional hardcoded ordering**: `ValidColorNames()` in `internal/client/color.go` returns a hardcoded slice in rainbow order (red, orange, yellow, green, blue, purple, gray) for user-friendly display. Dynamic generation from the `colorNames` map would lose this ordering since Go map iteration is non-deterministic. The 3-bit MailFlagBit encoding limits colors to exactly 7 values, so maintenance risk is negligible. Do not suggest generating this list dynamically from the map.
- **Flag usage-string matching is intentional**: `isRecipientToFilterFlag` in `cmd/filters.go` compares the `--to` flag's `Usage` field against the `recipientToUsage` constant to distinguish the recipient filter from the move destination flag. Both the registration and the check reference the same constant, so changes are caught at compile time. Do not suggest replacing this with flag annotations or other mechanisms.
